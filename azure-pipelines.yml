# Docker image
# Build a Docker image to deploy, run, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- circle_ci_publish

pool:
  vmImage: 'Ubuntu-16.04'

steps:
- script: docker-compose up -d && docker-compose run dockerapp python test.py
  workingDirectory: 'dockerapp'
  displayName: 'Initialize and Run Tests'
- script: docker login -u $(DOCKER_HUB_ID) -p $(DOCKER_HUB_PW) 
  displayName: log in to docker hub
- script: docker tag dockerapp_dockerapp $(DOCKER_HUB_ID)/dockerapp:$(Build.SourceVersion)
  displayName: tag with commit hash
- script: docker tag dockerapp_dockerapp $(DOCKER_HUB_ID)/dockerapp 
  displayName: tag with latest
- script: docker push $(DOCKER_HUB_ID)/dockerapp:$(Build.SourceVersion) 
  displayName: push tagged image
- script: docker push $(DOCKER_HUB_ID)/dockerapp
  displayName: push latest